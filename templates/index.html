{% extends "base.html" %}

{% block title %}CineSocial - é¡§æ™‰ç‘‹çš„ç¤¾ç¾¤ç¶²ç«™{% endblock %}

{% block content %}
<!-- åœ¨é¦–é é ‚éƒ¨æ·»åŠ å¿«é€Ÿè¨ªå•æŒ‰éˆ• -->
<div class="text-center mb-3">
    <a href="/explore" class="btn btn-primary">å‰å¾€æ¢ç´¢é é¢</a>
</div>

<!-- æ™‚é–“é¡¯ç¤º -->
<div class="social-card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“… ä»Šå¤©æ˜¯ {{ now|default('ç¾åœ¨æ™‚é–“') }}</h5>
            <a href="/about" class="btn btn-sm btn-outline-primary rounded-pill">
                ğŸ‘¤ é—œæ–¼æˆ‘
            </a>
        </div>
    </div>
</div>

<!-- æ¨™ç±¤åˆ‡æ› -->
<div class="social-card mb-4">
    <div class="card-body p-0">
        <ul class="nav nav-tabs nav-fill" id="feedTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="recommended-tab" data-bs-toggle="tab" data-bs-target="#recommended-content" type="button" role="tab" aria-controls="recommended-content" aria-selected="true">
                    ğŸ” æ¨è–¦çµ¦ä½ 
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="following-tab" data-bs-toggle="tab" data-bs-target="#following-content" type="button" role="tab" aria-controls="following-content" aria-selected="false">
                    ğŸ‘¥ è¿½è¹¤ä¸­
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="feedTabsContent">
            <!-- æ¨è–¦çµ¦ä½ å…§å®¹ -->
            <div class="tab-pane fade show active" id="recommended-content" role="tabpanel" aria-labelledby="recommended-tab">
                <!-- é€™è£¡æ˜¯ç¾æœ‰çš„è²¼æ–‡åˆ—è¡¨ä»£ç¢¼ -->
                {% if posts %}
                    {% for post in posts %}
                    <!-- ç¾æœ‰çš„è²¼æ–‡å¡ç‰‡çµæ§‹ -->
                    <div class="social-post">
                        <div class="social-post-header">
                            <img src="{{ post.user_avatar|default('/static/images/default-avatar.png') }}" class="social-avatar me-2" alt="{{ post.user_name }}">
                            <div>
                                <div class="fw-bold">{{ post.user_name }}</div>
                                <div class="small text-muted">{{ post.time_ago }}</div>
                            </div>
                        </div>
                        <div class="social-post-body">
                            <p>{{ post.text }}</p>
                            {% if post.image_url %}
                            <img src="{{ post.image_url }}" alt="è²¼æ–‡åœ–ç‰‡" class="img-fluid rounded mb-3">
                            {% endif %}
                            
                            {% if post.movie_id %}
                            <div class="d-flex align-items-center p-2 rounded mb-3" style="background-color: #f8f9fa;">
                                {% if post.movie_poster %}
                                <img src="{{ post.movie_poster }}" alt="{{ post.movie_title }}" class="social-movie-thumbnail me-2">
                                {% else %}
                                <div class="social-movie-thumbnail d-flex align-items-center justify-content-center bg-secondary me-2">
                                    <i class="fas fa-film text-light"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <a href="{{ url_for('movie_detail', movie_id=post.movie_id) }}" class="text-decoration-none">{{ post.movie_title }}</a>
                                    <div class="small text-muted">ç›¸é—œé›»å½±</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="social-post-footer">
                            <div class="social-post-actions">
                                <button type="button" class="btn btn-light me-2">
                                    ğŸ‘ è®š ({{ post.likes_count|default(0) }})
                                </button>
                                <button type="button">
                                    ğŸ’¬ ç•™è¨€ ({{ post.comments_count|default(0) }})
                                </button>
                                <button type="button">
                                    ğŸ”„ åˆ†äº«
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <!-- è¼‰å…¥æ›´å¤šæŒ‰éˆ• -->
                    <button class="btn btn-outline-primary w-100 mt-3" id="load-more">
                        ğŸ”„ è¼‰å…¥æ›´å¤š
                    </button>
                {% else %}
                    <div class="text-center p-4">
                        <p class="mb-0 text-muted">å°šç„¡æ¨è–¦è²¼æ–‡</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- è¿½è¹¤ä¸­å…§å®¹ -->
            <div class="tab-pane fade" id="following-content" role="tabpanel" aria-labelledby="following-tab">
                <div id="following-posts-container">
                    <!-- é€™è£¡æœƒé€šéAJAXå‹•æ…‹åŠ è¼‰è¿½è¹¤ä¸­çš„è²¼æ–‡ -->
                    <div class="text-center p-4" id="following-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                        </div>
                        <p class="mt-2">è¼‰å…¥è¿½è¹¤çš„è²¼æ–‡...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç™¼å¸ƒè²¼æ–‡å€ -->
{% if 'user_id' in session %}
<div class="social-card mb-4">
    <div class="card-body">
        <div class="d-flex">
            <img src="{{ user.avatar_url|default('/static/images/default-avatar.png') }}" class="social-avatar me-2" alt="{{ user.display_name }}">
            <form action="/create-post" method="POST" enctype="multipart/form-data" class="flex-grow-1">
                <div class="form-floating mb-3">
                    <textarea class="form-control" id="post-content" name="content" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." style="height: 100px"></textarea>
                    <label for="post-content">åˆ†äº«ä½ çš„æƒ³æ³•...</label>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-light me-2">
                            ğŸ–¼ï¸ ç…§ç‰‡
                        </button>
                        <button type="button" class="btn btn-light">
                            ğŸ¬ é›»å½±
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary px-4 rounded-pill">ç™¼å¸ƒ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- è¼‰å…¥æ›´å¤šæŒ‰éˆ• -->
{% if posts|length >= 5 %}
<div class="text-center mt-4 mb-3">
    <button class="btn btn-outline-primary rounded-pill px-4" id="load-more-btn">
        ğŸ”„ è¼‰å…¥æ›´å¤š
    </button>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // é»è®šåŠŸèƒ½
        const likeButtons = document.querySelectorAll('.social-post-actions button:first-child');
        likeButtons.forEach(button => {
            button.addEventListener('click', function() {
                // æ·»åŠ é»è®šå‹•ç•«å’Œå¢åŠ è¨ˆæ•¸çš„åŠŸèƒ½
                const icon = this.querySelector('i');
                if (icon.classList.contains('fa-thumbs-up') && !icon.classList.contains('text-primary')) {
                    icon.classList.add('text-primary');
                    
                    // æå–ç•¶å‰é»è®šæ•¸ä¸¦å¢åŠ 
                    const likeText = this.textContent.trim();
                    const likeCount = parseInt(likeText.match(/\d+/)[0]) + 1;
                    this.innerHTML = `<i class="fas fa-thumbs-up me-1 text-primary"></i> è®š (${likeCount})`;
                } else {
                    icon.classList.remove('text-primary');
                    
                    // æå–ç•¶å‰é»è®šæ•¸ä¸¦æ¸›å°‘
                    const likeText = this.textContent.trim();
                    const likeCount = Math.max(0, parseInt(likeText.match(/\d+/)[0]) - 1);
                    this.innerHTML = `<i class="fas fa-thumbs-up me-1"></i> è®š (${likeCount})`;
                }
            });
        });
        
        // è¼‰å…¥æ›´å¤šæŒ‰éˆ•åŠŸèƒ½
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function() {
                // æ¨¡æ“¬è¼‰å…¥ä¸­
                this.disabled = true;
                this.innerHTML = 'â³ è¼‰å…¥ä¸­...';
                
                // é€™è£¡æ‡‰è©²æœ‰ AJAX è«‹æ±‚æ›´å¤šè²¼æ–‡çš„åŠŸèƒ½
                setTimeout(() => {
                    // æ¨¡æ“¬è¼‰å…¥å®Œæˆ
                    this.disabled = false;
                    this.innerHTML = 'ğŸ”„ è¼‰å…¥æ›´å¤š';
                    // é¡¯ç¤ºæ²’æœ‰æ›´å¤šè²¼æ–‡çš„æç¤º
                    this.insertAdjacentHTML('afterend', '<p class="text-center text-muted mt-3">æ²’æœ‰æ›´å¤šè²¼æ–‡äº†</p>');
                    this.style.display = 'none';
                }, 1500);
            });
        }

        // åˆ‡æ›åˆ°è¿½è¹¤æ¨™ç±¤æ™‚åŠ è¼‰æ•¸æ“š
        const followingTab = document.getElementById('following-tab');
        let followingPostsLoaded = false;
        
        followingTab.addEventListener('click', function() {
            if (!followingPostsLoaded) {
                // é¦–æ¬¡åˆ‡æ›åˆ°è¿½è¹¤æ¨™ç±¤æ™‚åŠ è¼‰æ•¸æ“š
                loadFollowingPosts();
                followingPostsLoaded = true;
            }
        });
        
        function loadFollowingPosts() {
            const container = document.getElementById('following-posts-container');
            const loadingEl = document.getElementById('following-loading');
            
            // ç™¼é€AJAXè«‹æ±‚ç²å–è¿½è¹¤ä¸­çš„è²¼æ–‡
            fetch('/api/following-posts')
                .then(response => response.json())
                .then(data => {
                    // éš±è—è¼‰å…¥ä¸­æç¤º
                    loadingEl.style.display = 'none';
                    
                    if (data.posts && data.posts.length > 0) {
                        // é¡¯ç¤ºè¿½è¹¤çš„è²¼æ–‡
                        let postsHTML = '';
                        data.posts.forEach(post => {
                            postsHTML += `
                            <div class="social-post-card">
                                <div class="post-header d-flex align-items-center">
                                    <img src="${post.user_avatar || '/static/images/default-avatar.png'}" alt="${post.user_name}" class="social-avatar me-2">
                                    <div>
                                        <h6 class="mb-0">${post.user_name}</h6>
                                        <small class="text-muted">${post.time_ago}</small>
                                    </div>
                                </div>
                                <div class="post-content my-2">
                                    <p>${post.content}</p>
                                    ${post.image_url ? `<img src="${post.image_url}" alt="è²¼æ–‡åœ–ç‰‡" class="img-fluid rounded">` : ''}
                                </div>
                                <div class="post-actions d-flex justify-content-between">
                                    <button class="btn btn-sm btn-light post-like-btn ${post.user_liked ? 'text-danger' : ''}" data-post-id="${post.id}">
                                        ${post.user_liked ? 'â¤ï¸' : 'ğŸ¤'} ${post.likes_count || 0}
                                    </button>
                                    <button class="btn btn-sm btn-light">
                                        ğŸ’¬ ${post.comments_count || 0}
                                    </button>
                                    <button class="btn btn-sm btn-light">
                                        ğŸ”„
                                    </button>
                                </div>
                            </div>`;
                        });
                        container.innerHTML = postsHTML;
                        
                        // æ·»åŠ è¼‰å…¥æ›´å¤šæŒ‰éˆ•
                        container.innerHTML += `
                        <button class="btn btn-outline-primary w-100 mt-3" id="load-more-following">
                            ğŸ”„ è¼‰å…¥æ›´å¤š
                        </button>`;
                    } else {
                        // æ²’æœ‰è¿½è¹¤çš„è²¼æ–‡
                        container.innerHTML = `
                        <div class="text-center p-4">
                            <p class="mb-0 text-muted">æ²’æœ‰è¿½è¹¤ä¸­çš„è²¼æ–‡</p>
                            <a href="/explore" class="btn btn-primary mt-3">ç™¼ç¾ç”¨æˆ¶</a>
                        </div>`;
                    }
                    
                    // ç‚ºæ–°è¼‰å…¥çš„é»è®šæŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½
                    document.querySelectorAll('.post-like-btn').forEach(btn => {
                        btn.addEventListener('click', handleLikeClick);
                    });
                })
                .catch(error => {
                    console.error('è¼‰å…¥è¿½è¹¤è²¼æ–‡å¤±æ•—:', error);
                    loadingEl.style.display = 'none';
                    container.innerHTML = `
                    <div class="text-center p-4">
                        <p class="text-danger mb-0">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>
                    </div>`;
                });
        }
        
        // è™•ç†é»è®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
        function handleLikeClick(e) {
            const btn = e.currentTarget;
            const postId = btn.dataset.postId;
            
            fetch(`/like-post/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    if (data.liked) {
                        btn.classList.add('text-danger');
                        btn.innerHTML = btn.innerHTML.replace('ğŸ¤', 'â¤ï¸');
                    } else {
                        btn.classList.remove('text-danger');
                        btn.innerHTML = btn.innerHTML.replace('â¤ï¸', 'ğŸ¤');
                    }
                    
                    // æ›´æ–°é»è®šæ•¸
                    const likesCount = parseInt(btn.innerHTML.match(/\d+/)[0]);
                    btn.innerHTML = btn.innerHTML.replace(/\d+/, data.liked ? likesCount + 1 : likesCount - 1);
                }
            })
            .catch(error => console.error('é»è®šæ“ä½œå¤±æ•—:', error));
        }
    });
</script>
{% endblock %} 