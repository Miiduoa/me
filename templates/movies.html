{% extends "base.html" %}

{% block title %}é›»å½± - CineSocial{% endblock %}

{% block content %}
<div class="social-card mb-4">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ¬ æœ€æ–°é›»å½±</h5>
            <a href="/movies/categories" class="btn btn-sm btn-primary rounded-pill">
                ğŸ·ï¸ åˆ†é¡
            </a>
        </div>
    </div>
    
    <div class="card-body">
        {% if movies %}
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
            {% for movie in movies %}
            <div class="col">
                <div class="card h-100 movie-card">
                    <a href="/movie/{{ movie.id }}" class="text-decoration-none">
                        {% if movie.poster_url %}
                        <img src="{{ movie.poster_url }}" class="card-img-top movie-poster" alt="{{ movie.title }}">
                        {% else %}
                        <div class="card-img-top movie-poster-placeholder d-flex align-items-center justify-content-center bg-light">
                            ğŸ¬
                        </div>
                        {% endif %}
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1 text-truncate">{{ movie.title }}</h6>
                            <div class="small text-warning mb-1">
                                {% set rating = movie.rating|default(0)|int %}
                                {% for i in range(5) %}
                                    {% if i < rating %}â­{% else %}â˜†{% endif %}
                                {% endfor %}
                            </div>
                            <p class="card-text small text-muted mb-0">{{ movie.release_date|default('æœªçŸ¥æ—¥æœŸ') }}</p>
                        </div>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <h5 class="mb-3">ğŸ“­ ç›®å‰æ²’æœ‰é›»å½±è³‡æ–™</h5>
            <p class="text-muted mb-4">æ‚¨å¯ä»¥æ‰‹å‹•æ·»åŠ é›»å½±æˆ–ä½¿ç”¨çˆ¬èŸ²åŠŸèƒ½ç²å–æœ€æ–°é›»å½±è³‡è¨Š</p>
            
            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-primary" id="crawlMoviesBtn">
                    ğŸ”„ ç²å–é›»å½±è³‡æ–™
                </button>
                <button class="btn btn-outline-primary" id="sampleMoviesBtn">
                    ğŸ“š æ·»åŠ ç¤ºä¾‹é›»å½±
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addMovieModal">
                    â• æ‰‹å‹•æ·»åŠ é›»å½±
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ç†±é–€é›»å½±å€å¡Š -->
<div class="social-card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">ğŸ”¥ ç†±é–€é›»å½±</h5>
    </div>
    
    <div class="card-body">
        {% if trending_movies %}
        <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for movie in trending_movies %}
            <div class="col">
                <div class="card movie-card-horizontal">
                    <div class="row g-0">
                        <div class="col-4">
                            <a href="/movie/{{ movie.id }}">
                                {% if movie.poster_url %}
                                <img src="{{ movie.poster_url }}" class="img-fluid rounded-start h-100 w-100 object-fit-cover" alt="{{ movie.title }}">
                                {% else %}
                                <div class="bg-light rounded-start d-flex align-items-center justify-content-center h-100">
                                    ğŸ¬
                                </div>
                                {% endif %}
                            </a>
                        </div>
                        <div class="col-8">
                            <div class="card-body">
                                <h5 class="card-title">{{ movie.title }}</h5>
                                <div class="text-warning mb-2">
                                    {% set rating = movie.rating|default(0)|int %}
                                    {% for i in range(rating) %}â­{% endfor %}
                                </div>
                                <p class="card-text small">{{ movie.description|truncate(100) }}</p>
                                <a href="/movie/{{ movie.id }}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹è©³æƒ…</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <p class="text-muted">é‚„æ²’æœ‰ç†±é–€é›»å½±æ•¸æ“š</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- æ·»åŠ é›»å½±Modal -->
<div class="modal fade" id="addMovieModal" tabindex="-1" aria-labelledby="addMovieModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMovieModalLabel">â• æ·»åŠ æ–°é›»å½±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addMovieForm" action="/add-movie" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="movieTitle" class="form-label">é›»å½±æ¨™é¡Œ</label>
                        <input type="text" class="form-control" id="movieTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="movieDescription" class="form-label">ç°¡ä»‹</label>
                        <textarea class="form-control" id="movieDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="movieRating" class="form-label">è©•åˆ† (1-5)</label>
                                <input type="number" class="form-control" id="movieRating" name="rating" min="1" max="5">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="movieReleaseDate" class="form-label">ä¸Šæ˜ æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="movieReleaseDate" name="release_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="moviePosterUrl" class="form-label">æµ·å ±URL</label>
                        <input type="url" class="form-control" id="moviePosterUrl" name="poster_url">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ é›»å½±</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const crawlBtn = document.getElementById('crawlMoviesBtn');
        if (crawlBtn) {
            crawlBtn.addEventListener('click', function() {
                // é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
                this.disabled = true;
                this.innerHTML = 'â³ è¼‰å…¥ä¸­...';
                
                // æ·»åŠ éŒ¯èª¤è™•ç†å’Œæ›´å¤šæ—¥èªŒè¼¸å‡º
                console.log('é»æ“Šç²å–é›»å½±è³‡æ–™æŒ‰éˆ•');
                
                // ç™¼é€è«‹æ±‚çˆ¬å–é›»å½±æ•¸æ“š
                fetch('/crawl-movies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // æ·»åŠ ç©ºçš„è«‹æ±‚é«”
                    body: JSON.stringify({})
                })
                .then(response => {
                    console.log('æ”¶åˆ°å›æ‡‰:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('è™•ç†æ•¸æ“š:', data);
                    if (data.success) {
                        alert('æˆåŠŸç²å–é›»å½±æ•¸æ“šï¼');
                        // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ–°é›»å½±
                        window.location.reload();
                    } else {
                        alert('ç²å–é›»å½±æ•¸æ“šå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                        this.disabled = false;
                        this.innerHTML = 'ğŸ”„ ç²å–é›»å½±è³‡æ–™';
                    }
                })
                .catch(error => {
                    console.error('éŒ¯èª¤:', error);
                    alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦: ' + error.message);
                    this.disabled = false;
                    this.innerHTML = 'ğŸ”„ ç²å–é›»å½±è³‡æ–™';
                });
            });
        } else {
            console.error('æ‰¾ä¸åˆ°çˆ¬å–é›»å½±æŒ‰éˆ•å…ƒç´ ');
        }

        // æ·»åŠ ç¤ºä¾‹é›»å½±æŒ‰éˆ•äº‹ä»¶è™•ç†
        const sampleBtn = document.getElementById('sampleMoviesBtn');
        if (sampleBtn) {
            sampleBtn.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = 'â³ è™•ç†ä¸­...';
                
                fetch('/add-sample-movies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æˆåŠŸæ·»åŠ ç¤ºä¾‹é›»å½±ï¼');
                        window.location.reload();
                    } else {
                        alert('æ·»åŠ å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                        this.disabled = false;
                        this.innerHTML = 'ğŸ“š æ·»åŠ ç¤ºä¾‹é›»å½±';
                    }
                })
                .catch(error => {
                    console.error('éŒ¯èª¤:', error);
                    alert('ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                    this.disabled = false;
                    this.innerHTML = 'ğŸ“š æ·»åŠ ç¤ºä¾‹é›»å½±';
                });
            });
        }
    });
</script>
{% endblock %} 